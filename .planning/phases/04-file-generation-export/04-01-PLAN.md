# Phase 4 Plan 1: File Generation & Export

## Context

**Phase Goal**: Generate markdown files with frontmatter compatible with Claude Code CLI workflows

**Current State**:
- Phase 3 complete - PRD, Tech Spec, and ADRs are generated and stored in `PlanningSession`
- Documents exist as markdown strings in memory
- Phase 2 implemented download buttons for individual documents (client-side Blob API)
- Need to add YAML frontmatter for Claude Code CLI compatibility
- Need to implement export workflow that packages all documents together

**Dependencies**:
- Phase 3 (Design Phase UI) ✓ Complete
- Existing data structures: `RequirementsFormData.generatedPRD`, `DesignFormData.generatedTechSpec/generatedADRs`
- Existing download functions: `downloadPRD()`, `downloadTechSpec()`, `downloadADR()` (client-side only)

**Discovery**: Level 0 (skip) - Standard file I/O and markdown templating

## Objective

Transform in-memory markdown documents into Claude Code-compatible files with proper frontmatter, and create export workflow for downloading complete documentation package.

## Scope

**In Scope**:
- YAML frontmatter generation for PRD, Tech Spec, ADR documents
- Backend API endpoints for file export with proper HTTP headers
- Frontend "Export All Documentation" button in completion workflow
- Proper filename conventions (kebab-case, sequential ADR numbering)
- Metadata in frontmatter: phase, generatedAt, projectName, version

**Out of Scope**:
- File system persistence (files downloaded to user's machine only)
- Git integration or version control automation
- Batch export to zip/tarball (download individual files sequentially)
- Custom frontmatter field configuration (use standard Claude Code fields)
- Implementation planning phase UI (Phase 5)

## Tasks

### Task 1: Frontmatter Generation Utilities

**What**: Create TypeScript functions to add YAML frontmatter to markdown documents

**Acceptance Criteria**:
- `addFrontmatterToPRD(prd: string, metadata: object): string` function in server.ts
- `addFrontmatterToTechSpec(techSpec: string, metadata: object): string` function
- `addFrontmatterToADR(adr: GeneratedADR, metadata: object): string` function
- Frontmatter includes: `phase`, `document_type`, `generated_at`, `project_name`, `version: "1.0"`
- ADR frontmatter includes: `adr_number` (e.g., "001", "002") and `status: "proposed"`
- YAML syntax validated (triple-dash delimiters, proper key-value format)
- Functions return complete markdown with frontmatter prepended

**Implementation Notes**:
- Use template literals for YAML generation
- Sanitize metadata values (escape quotes, handle newlines)
- ADR numbering: extract index from `GeneratedADR.id` (e.g., "ADR-001" → "001")
- Document types: "PRD", "Technical Specification", "Architecture Decision Record"

**Estimated Effort**: 30 min

---

### Task 2: Backend Export API Endpoints

**What**: Create REST endpoints that return markdown files with proper Content-Disposition headers

**Acceptance Criteria**:
- GET `/api/planning/export/prd` endpoint returns PRD with frontmatter
- GET `/api/planning/export/techspec` endpoint returns Tech Spec with frontmatter
- GET `/api/planning/export/adr/:adrIndex` endpoint returns specific ADR with frontmatter
- All endpoints set `Content-Type: text/markdown; charset=utf-8`
- All endpoints set `Content-Disposition: attachment; filename="[name].md"`
- Filename conventions:
  - PRD: `{project-name}-PRD.md` (kebab-case)
  - Tech Spec: `{project-name}-TechSpec.md`
  - ADR: `ADR-{number}-{title}.md` (e.g., "ADR-001-Use-PostgreSQL.md")
- Return 404 if document not found (e.g., PRD not generated yet)
- Return 400 if invalid ADR index

**Implementation Notes**:
- Reuse existing session validation logic
- Call frontmatter functions from Task 1
- Extract project name from `PlanningSession.projectName`
- Sanitize filenames (remove special characters, replace spaces with hyphens)

**Estimated Effort**: 30 min

---

### Task 3: Frontend Export UI Integration

**What**: Add "Export All Documentation" workflow to phase completion UI

**Acceptance Criteria**:
- "Export All Documentation" button appears after Design Phase completion (alongside "Complete Design Phase")
- Button triggers sequential download of all generated documents:
  1. PRD (if exists)
  2. Tech Spec (if exists)
  3. All ADRs (if exist)
- Visual feedback during export: "Exporting documentation... (3 of 5 files)"
- Button disabled during export to prevent double-clicks
- Success message: "✓ Exported 5 documents successfully"
- Error handling: Show which files failed to export if any

**Implementation Notes**:
- Use existing `fetch()` patterns from Phase 2/3
- Trigger downloads using browser anchor element with `download` attribute
- Sequential downloads with 200ms delay between each (prevent browser blocking)
- Count total documents before starting export
- Display count in progress message

**Estimated Effort**: 30 min

---

### Task 4: Manual Verification Checkpoint

**What**: Human-in-the-loop verification of exported files

**Verification Steps**:
1. Complete Requirements and Design phases in UI
2. Click "Export All Documentation" button
3. Verify 5+ files downloaded to Downloads folder
4. Open PRD markdown file - verify frontmatter exists and is valid YAML
5. Open Tech Spec - verify frontmatter and content intact
6. Open ADR files - verify sequential numbering (ADR-001, ADR-002, etc.)
7. Verify filenames follow conventions (kebab-case, no special characters)
8. **Claude Code CLI Test**: Place exported files in `.claude/docs/` and run `claude` CLI to verify parsing

**Success Criteria**:
- All files download successfully
- Frontmatter is valid YAML (no syntax errors)
- Filenames are clean and follow conventions
- Content is unchanged from in-app display
- Claude Code CLI recognizes frontmatter (no parsing warnings)

**If Issues Found**: Return to Task 1-3 to fix frontmatter format or export logic

**Estimated Effort**: 15 min

---

## Execution Strategy

**Strategy**: Linear (Tasks 1 → 2 → 3 → 4) - Each task depends on previous completion

**Reasoning**:
- Task 2 (backend) depends on Task 1 (frontmatter utilities)
- Task 3 (frontend) depends on Task 2 (endpoints)
- Task 4 (verification) depends on Task 3 (UI integration)
- No parallelization opportunity due to sequential dependencies

**Checkpoint Placement**:
- After Task 3 completion (before Task 4)
- Allows human verification of exported files before declaring phase complete
- Critical for Claude Code CLI compatibility validation

**Agent Assignment**:
- Tasks 1-3: Self-implementation (straightforward utility functions and API endpoints)
- Task 4: Human checkpoint (requires manual file inspection and CLI testing)

## Success Criteria

**Phase Complete When**:
- ✅ All generated documents (PRD, Tech Spec, ADRs) can be exported with frontmatter
- ✅ Exported files follow Claude Code CLI conventions (YAML frontmatter, markdown content)
- ✅ Filenames are clean and descriptive (kebab-case, sequential ADR numbering)
- ✅ Export workflow is user-friendly (progress feedback, error handling)
- ✅ Checkpoint verification confirms Claude Code CLI compatibility

**Deliverables**:
1. Three frontmatter generation functions in server.ts
2. Three export API endpoints (PRD, Tech Spec, ADR)
3. Frontend "Export All Documentation" button with progress feedback
4. Verified exported files compatible with Claude Code CLI workflows

## Risk Assessment

**Low Risk** - All tasks use existing patterns and standard file I/O

**Potential Issues**:
1. **YAML syntax errors in frontmatter** - Mitigated by template literals and metadata sanitization
2. **Filename special character issues** - Mitigated by sanitization function (replace/remove invalid chars)
3. **Browser download blocking** - Mitigated by 200ms delay between sequential downloads
4. **Claude Code CLI frontmatter incompatibility** - Mitigated by checkpoint verification in Task 4

**No External Dependencies** - All work uses existing Hono server, TypeScript, and browser APIs
